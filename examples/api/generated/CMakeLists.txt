# Auto-generated by rosetta-gen
# DO NOT EDIT MANUALLY

cmake_minimum_required(VERSION 3.15)
project(myapi_bindings)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS ON)

# Build options
option(BUILD_NODE_ADDON "Build Node.js addon" OFF)
option(BUILD_PYTHON_ADDON "Build Python addon" OFF)

# Find required packages
include_directories(../../../include)

# Collect all generated wrapper sources
set(WRAPPER_SOURCES
    IMesh.cpp
    IPoint.cpp
    bindings.cpp
)

# Create bindings library
add_library(myapi_bindings SHARED
    ${WRAPPER_SOURCES}
)

# Link against original library and rosetta
target_link_libraries(myapi_bindings
    myapi  # Your original API library
    rosetta
)

# Include directories
target_include_directories(myapi_bindings PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}
)

# ============================================================================
# Node.js Addon Configuration
# ============================================================================
if(BUILD_NODE_ADDON)
    message(STATUS "Building Node.js addon")
    
    # Find Node.js
    find_program(NODE_EXECUTABLE NAMES node nodejs REQUIRED)
    
    # Check if node-addon-api is installed
    execute_process(
        COMMAND ${NODE_EXECUTABLE} -p "try { require.resolve('node-addon-api'); 'installed' } catch(e) { 'not-installed' }"
        WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
        OUTPUT_VARIABLE NODE_ADDON_API_STATUS
        OUTPUT_STRIP_TRAILING_WHITESPACE
    )
    
    if(NODE_ADDON_API_STATUS STREQUAL "not-installed")
        message(STATUS "node-addon-api not found, installing...")
        execute_process(
            COMMAND ${NODE_EXECUTABLE} -e "require('child_process').execSync('npm install node-addon-api', {stdio: 'inherit'})"
            WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
            RESULT_VARIABLE NPM_INSTALL_RESULT
        )
        if(NOT NPM_INSTALL_RESULT EQUAL 0)
            message(FATAL_ERROR "Failed to install node-addon-api. Please run: npm install node-addon-api")
        endif()
    else()
        message(STATUS "node-addon-api is already installed")
    endif()
    
    # Get node-addon-api include directory
    execute_process(
        COMMAND ${NODE_EXECUTABLE} -p "require('node-addon-api').include"
        WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
        OUTPUT_VARIABLE NODE_ADDON_API_DIR
        OUTPUT_STRIP_TRAILING_WHITESPACE
    )
    
    # Get Node.js include directory
    execute_process(
        COMMAND ${NODE_EXECUTABLE} -p "process.execPath"
        OUTPUT_VARIABLE NODE_EXEC_PATH
        OUTPUT_STRIP_TRAILING_WHITESPACE
    )
    
    get_filename_component(NODE_ROOT_DIR "${NODE_EXEC_PATH}" DIRECTORY)
    get_filename_component(NODE_ROOT_DIR "${NODE_ROOT_DIR}" DIRECTORY)
    set(NODE_INCLUDE_DIR "${NODE_ROOT_DIR}/include/node")
    
    # Verify Node.js headers exist
    if(NOT EXISTS "${NODE_INCLUDE_DIR}/node.h")
        message(FATAL_ERROR "Node.js headers not found at ${NODE_INCLUDE_DIR}. "
                            "Please install Node.js development headers.")
    endif()
    
    target_include_directories(myapi_bindings PRIVATE
        ${NODE_ADDON_API_DIR}
        ${NODE_INCLUDE_DIR}
        ${CMAKE_JS_INC}
    )
    
    # Define NAPI_VERSION
    # target_compile_definitions({project_name}_bindings PRIVATE NAPI_VERSION=8)
    
    # Set Node.js addon properties
    set_target_properties(myapi_bindings PROPERTIES
        PREFIX ""
        SUFFIX ".node"
        OUTPUT_NAME "myapi"
    )
    
    message(STATUS "Node.js include dir: ${NODE_INCLUDE_DIR}")
    message(STATUS "node-addon-api dir: ${NODE_ADDON_API_DIR}")
endif()

# ============================================================================
# Python Addon Configuration
# ============================================================================
if(BUILD_PYTHON_ADDON)
    message(STATUS "Building Python addon")
    
    # Find Python
    find_package(Python COMPONENTS Interpreter Development REQUIRED)
    
    message(STATUS "Python version: ${Python_VERSION}")
    message(STATUS "Python include dir: ${Python_INCLUDE_DIRS}")
    message(STATUS "Python library: ${Python_LIBRARIES}")
    
    # Check if pybind11 is installed
    execute_process(
        COMMAND ${Python_EXECUTABLE} -c "import pybind11; print(pybind11.get_cmake_dir())"
        OUTPUT_VARIABLE PYBIND11_CMAKE_DIR
        OUTPUT_STRIP_TRAILING_WHITESPACE
        RESULT_VARIABLE PYBIND11_CHECK_RESULT
    )
    
    if(NOT PYBIND11_CHECK_RESULT EQUAL 0)
        message(STATUS "pybind11 not found, installing...")
        execute_process(
            COMMAND ${Python_EXECUTABLE} -m pip install pybind11
            RESULT_VARIABLE PIP_INSTALL_RESULT
        )
        if(NOT PIP_INSTALL_RESULT EQUAL 0)
            message(FATAL_ERROR "Failed to install pybind11. Please run: pip install pybind11")
        endif()
        
        # Get pybind11 cmake dir again after installation
        execute_process(
            COMMAND ${Python_EXECUTABLE} -c "import pybind11; print(pybind11.get_cmake_dir())"
            OUTPUT_VARIABLE PYBIND11_CMAKE_DIR
            OUTPUT_STRIP_TRAILING_WHITESPACE
        )
    else()
        message(STATUS "pybind11 is already installed")
    endif()
    
    # Add pybind11 cmake directory to module path
    list(APPEND CMAKE_PREFIX_PATH "${PYBIND11_CMAKE_DIR}")
    
    # Find pybind11
    find_package(pybind11 REQUIRED)
    
    message(STATUS "pybind11 include dir: ${pybind11_INCLUDE_DIR}")
    
    # Add Python bindings target
    pybind11_add_module(myapi_python
        ${WRAPPER_SOURCES}
    )
    
    target_link_libraries(myapi_python PRIVATE
        myapi
        rosetta
    )
    
    target_include_directories(myapi_python PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}
        ${pybind11_INCLUDE_DIR}
    )
    
    # Set Python module properties
    set_target_properties(myapi_python PROPERTIES
        OUTPUT_NAME "myapi"
        PREFIX "${PYTHON_MODULE_PREFIX}"
        SUFFIX "${PYTHON_MODULE_EXTENSION}"
    )
endif()

# ============================================================================
# Installation
# ============================================================================
if(BUILD_NODE_ADDON)
    install(TARGETS myapi_bindings
        LIBRARY DESTINATION lib
        RUNTIME DESTINATION bin
    )
endif()

if(BUILD_PYTHON_ADDON)
    install(TARGETS myapi_python
        LIBRARY DESTINATION ${Python_SITEARCH}
    )
endif()

if(NOT BUILD_NODE_ADDON AND NOT BUILD_PYTHON_ADDON)
    # Default installation for standalone library
    install(TARGETS myapi_bindings
        LIBRARY DESTINATION lib
        RUNTIME DESTINATION bin
    )
endif()
